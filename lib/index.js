var W=Object.create;var A=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var Q=a=>A(a,"__esModule",{value:!0});var E=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports);var X=(a,s,c)=>{if(s&&typeof s=="object"||typeof s=="function")for(let u of G(s))!K.call(a,u)&&u!=="default"&&A(a,u,{get:()=>s[u],enumerable:!(c=H(s,u))||c.enumerable});return a},z=a=>X(Q(A(a!=null?W(J(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var j=E((ct,F)=>{var Z=/^\[?([^\]]+)]?:(\d+)$/,g=new Map;F.exports=function(s){if(g.size===1e5&&g.clear(),!g.has(s)){let c=Z.exec(s);if(!c)throw new Error(`invalid addr: ${s}`);g.set(s,[c[1],Number(c[2])])}return g.get(s)}});var D=E((L,b)=>{(function(a){"use strict";let s="(0?\\d+|0x[a-f0-9]+)",c={fourOctet:new RegExp(`^${s}\\.${s}\\.${s}\\.${s}$`,"i"),threeOctet:new RegExp(`^${s}\\.${s}\\.${s}$`,"i"),twoOctet:new RegExp(`^${s}\\.${s}$`,"i"),longValue:new RegExp(`^${s}$`,"i")},u=new RegExp("^0[0-7]+$","i"),I=new RegExp("^0x[a-f0-9]+$","i"),d="%[0-9a-z]{1,}",l="(?:[0-9a-f]+::?)+",h={zoneIndex:new RegExp(d,"i"),native:new RegExp(`^(::)?(${l})?([0-9a-f]+)?(::)?(${d})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${s}\\.${s}\\.${s}\\.${s}(${d})?)$`,"i"),transitional:new RegExp(`^((?:${l})|(?:::)(?:${l})?)${s}\\.${s}\\.${s}\\.${s}(${d})?$`,"i")};function v(t,e){if(t.indexOf("::")!==t.lastIndexOf("::"))return null;let n=0,r=-1,o=(t.match(h.zoneIndex)||[])[0],i,p;for(o&&(o=o.substring(1),t=t.replace(/%.+$/,""));(r=t.indexOf(":",r+1))>=0;)n++;if(t.substr(0,2)==="::"&&n--,t.substr(-2,2)==="::"&&n--,n>e)return null;for(p=e-n,i=":";p--;)i+="0:";return t=t.replace("::",i),t[0]===":"&&(t=t.slice(1)),t[t.length-1]===":"&&(t=t.slice(0,-1)),e=function(){let M=t.split(":"),S=[];for(let R=0;R<M.length;R++)S.push(parseInt(M[R],16));return S}(),{parts:e,zoneId:o}}function P(t,e,n,r){if(t.length!==e.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let o=0,i;for(;r>0;){if(i=n-r,i<0&&(i=0),t[o]>>i!=e[o]>>i)return!1;r-=n,o+=1}return!0}function w(t){if(I.test(t))return parseInt(t,16);if(t[0]==="0"&&!isNaN(parseInt(t[1],10))){if(u.test(t))return parseInt(t,8);throw new Error(`ipaddr: cannot parse ${t} as octal`)}return parseInt(t,10)}function y(t,e){for(;t.length<e;)t=`0${t}`;return t}let f={};f.IPv4=function(){function t(e){if(e.length!==4)throw new Error("ipaddr: ipv4 octet count should be 4");let n,r;for(n=0;n<e.length;n++)if(r=e[n],!(0<=r&&r<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=e}return t.prototype.SpecialRanges={unspecified:[[new t([0,0,0,0]),8]],broadcast:[[new t([255,255,255,255]),32]],multicast:[[new t([224,0,0,0]),4]],linkLocal:[[new t([169,254,0,0]),16]],loopback:[[new t([127,0,0,0]),8]],carrierGradeNat:[[new t([100,64,0,0]),10]],private:[[new t([10,0,0,0]),8],[new t([172,16,0,0]),12],[new t([192,168,0,0]),16]],reserved:[[new t([192,0,0,0]),24],[new t([192,0,2,0]),24],[new t([192,88,99,0]),24],[new t([198,51,100,0]),24],[new t([203,0,113,0]),24],[new t([240,0,0,0]),4]]},t.prototype.kind=function(){return"ipv4"},t.prototype.match=function(e,n){let r;if(n===void 0&&(r=e,e=r[0],n=r[1]),e.kind()!=="ipv4")throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return P(this.octets,e.octets,8,n)},t.prototype.prefixLengthFromSubnetMask=function(){let e=0,n=!1,r={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0},o,i,p;for(o=3;o>=0;o-=1)if(i=this.octets[o],i in r){if(p=r[i],n&&p!==0)return null;p!==8&&(n=!0),e+=p}else return null;return 32-e},t.prototype.range=function(){return f.subnetMatch(this,this.SpecialRanges)},t.prototype.toByteArray=function(){return this.octets.slice(0)},t.prototype.toIPv4MappedAddress=function(){return f.IPv6.parse(`::ffff:${this.toString()}`)},t.prototype.toNormalizedString=function(){return this.toString()},t.prototype.toString=function(){return this.octets.join(".")},t}(),f.IPv4.broadcastAddressFromCIDR=function(t){try{let e=this.parseCIDR(t),n=e[0].toByteArray(),r=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),o=[],i=0;for(;i<4;)o.push(parseInt(n[i],10)|parseInt(r[i],10)^255),i++;return new this(o)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},f.IPv4.isIPv4=function(t){return this.parser(t)!==null},f.IPv4.isValid=function(t){try{return new this(this.parser(t)),!0}catch{return!1}},f.IPv4.isValidFourPartDecimal=function(t){return!!(f.IPv4.isValid(t)&&t.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},f.IPv4.networkAddressFromCIDR=function(t){let e,n,r,o,i;try{for(e=this.parseCIDR(t),r=e[0].toByteArray(),i=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),o=[],n=0;n<4;)o.push(parseInt(r[n],10)&parseInt(i[n],10)),n++;return new this(o)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},f.IPv4.parse=function(t){let e=this.parser(t);if(e===null)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(e)},f.IPv4.parseCIDR=function(t){let e;if(e=t.match(/^(.+)\/(\d+)$/)){let n=parseInt(e[2]);if(n>=0&&n<=32){let r=[this.parse(e[1]),n];return Object.defineProperty(r,"toString",{value:function(){return this.join("/")}}),r}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},f.IPv4.parser=function(t){let e,n,r;if(e=t.match(c.fourOctet))return function(){let o=e.slice(1,6),i=[];for(let p=0;p<o.length;p++)n=o[p],i.push(w(n));return i}();if(e=t.match(c.longValue)){if(r=w(e[1]),r>4294967295||r<0)throw new Error("ipaddr: address outside defined range");return function(){let o=[],i;for(i=0;i<=24;i+=8)o.push(r>>i&255);return o}().reverse()}else return(e=t.match(c.twoOctet))?function(){let o=e.slice(1,4),i=[];if(r=w(o[1]),r>16777215||r<0)throw new Error("ipaddr: address outside defined range");return i.push(w(o[0])),i.push(r>>16&255),i.push(r>>8&255),i.push(r&255),i}():(e=t.match(c.threeOctet))?function(){let o=e.slice(1,5),i=[];if(r=w(o[2]),r>65535||r<0)throw new Error("ipaddr: address outside defined range");return i.push(w(o[0])),i.push(w(o[1])),i.push(r>>8&255),i.push(r&255),i}():null},f.IPv4.subnetMaskFromPrefixLength=function(t){if(t=parseInt(t),t<0||t>32)throw new Error("ipaddr: invalid IPv4 prefix length");let e=[0,0,0,0],n=0,r=Math.floor(t/8);for(;n<r;)e[n]=255,n++;return r<4&&(e[r]=Math.pow(2,t%8)-1<<8-t%8),new this(e)},f.IPv6=function(){function t(e,n){let r,o;if(e.length===16)for(this.parts=[],r=0;r<=14;r+=2)this.parts.push(e[r]<<8|e[r+1]);else if(e.length===8)this.parts=e;else throw new Error("ipaddr: ipv6 part count should be 8 or 16");for(r=0;r<this.parts.length;r++)if(o=this.parts[r],!(0<=o&&o<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");n&&(this.zoneId=n)}return t.prototype.SpecialRanges={unspecified:[new t([0,0,0,0,0,0,0,0]),128],linkLocal:[new t([65152,0,0,0,0,0,0,0]),10],multicast:[new t([65280,0,0,0,0,0,0,0]),8],loopback:[new t([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new t([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new t([0,0,0,0,0,65535,0,0]),96],rfc6145:[new t([0,0,0,0,65535,0,0,0]),96],rfc6052:[new t([100,65435,0,0,0,0,0,0]),96],"6to4":[new t([8194,0,0,0,0,0,0,0]),16],teredo:[new t([8193,0,0,0,0,0,0,0]),32],reserved:[[new t([8193,3512,0,0,0,0,0,0]),32]]},t.prototype.isIPv4MappedAddress=function(){return this.range()==="ipv4Mapped"},t.prototype.kind=function(){return"ipv6"},t.prototype.match=function(e,n){let r;if(n===void 0&&(r=e,e=r[0],n=r[1]),e.kind()!=="ipv6")throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return P(this.parts,e.parts,16,n)},t.prototype.prefixLengthFromSubnetMask=function(){let e=0,n=!1,r={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0},o,i;for(let p=7;p>=0;p-=1)if(o=this.parts[p],o in r){if(i=r[o],n&&i!==0)return null;i!==16&&(n=!0),e+=i}else return null;return 128-e},t.prototype.range=function(){return f.subnetMatch(this,this.SpecialRanges)},t.prototype.toByteArray=function(){let e,n=[],r=this.parts;for(let o=0;o<r.length;o++)e=r[o],n.push(e>>8),n.push(e&255);return n},t.prototype.toFixedLengthString=function(){let e=function(){let r=[];for(let o=0;o<this.parts.length;o++)r.push(y(this.parts[o].toString(16),4));return r}.call(this).join(":"),n="";return this.zoneId&&(n=`%${this.zoneId}`),e+n},t.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");let e=this.parts.slice(-2),n=e[0],r=e[1];return new f.IPv4([n>>8,n&255,r>>8,r&255])},t.prototype.toNormalizedString=function(){let e=function(){let r=[];for(let o=0;o<this.parts.length;o++)r.push(this.parts[o].toString(16));return r}.call(this).join(":"),n="";return this.zoneId&&(n=`%${this.zoneId}`),e+n},t.prototype.toRFC5952String=function(){let e=/((^|:)(0(:|$)){2,})/g,n=this.toNormalizedString(),r=0,o=-1,i;for(;i=e.exec(n);)i[0].length>o&&(r=i.index,o=i[0].length);return o<0?n:`${n.substring(0,r)}::${n.substring(r+o)}`},t.prototype.toString=function(){return this.toNormalizedString().replace(/((^|:)(0(:|$))+)/,"::")},t}(),f.IPv6.broadcastAddressFromCIDR=function(t){try{let e=this.parseCIDR(t),n=e[0].toByteArray(),r=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),o=[],i=0;for(;i<16;)o.push(parseInt(n[i],10)|parseInt(r[i],10)^255),i++;return new this(o)}catch(e){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${e})`)}},f.IPv6.isIPv6=function(t){return this.parser(t)!==null},f.IPv6.isValid=function(t){if(typeof t=="string"&&t.indexOf(":")===-1)return!1;try{let e=this.parser(t);return new this(e.parts,e.zoneId),!0}catch{return!1}},f.IPv6.networkAddressFromCIDR=function(t){let e,n,r,o,i;try{for(e=this.parseCIDR(t),r=e[0].toByteArray(),i=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),o=[],n=0;n<16;)o.push(parseInt(r[n],10)&parseInt(i[n],10)),n++;return new this(o)}catch(p){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${p})`)}},f.IPv6.parse=function(t){let e=this.parser(t);if(e.parts===null)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(e.parts,e.zoneId)},f.IPv6.parseCIDR=function(t){let e,n,r;if((n=t.match(/^(.+)\/(\d+)$/))&&(e=parseInt(n[2]),e>=0&&e<=128))return r=[this.parse(n[1]),e],Object.defineProperty(r,"toString",{value:function(){return this.join("/")}}),r;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},f.IPv6.parser=function(t){let e,n,r,o,i,p;if(r=t.match(h.deprecatedTransitional))return this.parser(`::ffff:${r[1]}`);if(h.native.test(t))return v(t,8);if((r=t.match(h.transitional))&&(p=r[6]||"",e=v(r[1].slice(0,-1)+p,6),e.parts)){for(i=[parseInt(r[2]),parseInt(r[3]),parseInt(r[4]),parseInt(r[5])],n=0;n<i.length;n++)if(o=i[n],!(0<=o&&o<=255))return null;return e.parts.push(i[0]<<8|i[1]),e.parts.push(i[2]<<8|i[3]),{parts:e.parts,zoneId:e.zoneId}}return null},f.IPv6.subnetMaskFromPrefixLength=function(t){if(t=parseInt(t),t<0||t>128)throw new Error("ipaddr: invalid IPv6 prefix length");let e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n=0,r=Math.floor(t/8);for(;n<r;)e[n]=255,n++;return r<16&&(e[r]=Math.pow(2,t%8)-1<<8-t%8),new this(e)},f.fromByteArray=function(t){let e=t.length;if(e===4)return new f.IPv4(t);if(e===16)return new f.IPv6(t);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},f.isValid=function(t){return f.IPv6.isValid(t)||f.IPv4.isValid(t)},f.parse=function(t){if(f.IPv6.isValid(t))return f.IPv6.parse(t);if(f.IPv4.isValid(t))return f.IPv4.parse(t);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},f.parseCIDR=function(t){try{return f.IPv6.parseCIDR(t)}catch{try{return f.IPv4.parseCIDR(t)}catch{throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},f.process=function(t){let e=this.parse(t);return e.kind()==="ipv6"&&e.isIPv4MappedAddress()?e.toIPv4Address():e},f.subnetMatch=function(t,e,n){let r,o,i,p;n==null&&(n="unicast");for(o in e)if(Object.prototype.hasOwnProperty.call(e,o)){for(i=e[o],i[0]&&!(i[0]instanceof Array)&&(i=[i]),r=0;r<i.length;r++)if(p=i[r],t.kind()===p[0].kind()&&t.match.apply(t,p))return o}return n},typeof b!="undefined"&&b.exports?b.exports=f:a.ipaddr=f})(L)});var T=E((pt,m)=>{var tt=j(),et=D();m.exports=a=>(typeof a=="string"&&(a=[a]),Buffer.concat(a.map(s=>{let c=tt(s);if(c.length!==2)throw new Error("invalid address format, expecting: 10.10.10.5:128");let u=et.parse(c[0]),I=Buffer.from(u.toByteArray()),d=c[1],l=Buffer.allocUnsafe(2);return l.writeUInt16BE(d,0),Buffer.concat([I,l])})));m.exports.multi=m.exports;m.exports.multi6=m.exports});var U=E((ut,V)=>{var rt=D(),x=function(a){switch(a.length){case 6:return a[0]+"."+a[1]+"."+a[2]+"."+a[3]+":"+a.readUInt16BE(4);case 18:for(var s=[],c=0;c<8;c++)s.push(a.readUInt16BE(c*2).toString(16));var u=rt.parse(s.join(":")).toString();return"["+u+"]:"+a.readUInt16BE(16);default:throw new Error("Invalid Compact IP/PORT, It should contain 6 or 18 bytes")}};x.multi=function(a){if(a.length%6!=0)throw new Error("buf length isn't multiple of compact IP/PORTs (6 bytes)");for(var s=[],c=0;c<=a.length-1;c=c+6)s.push(x(a.slice(c,c+6)));return s};x.multi6=function(a){if(a.length%18!=0)throw new Error("buf length isn't multiple of compact IP6/PORTs (18 bytes)");for(var s=[],c=0;c<=a.length-1;c=c+18)s.push(x(a.slice(c,c+18)));return s};V.exports=x});var Y,B=Y=class{constructor(s=10){this.add=this.add.bind(this),this.all=this.all.bind(this),this.n=s,this.now=0}add(s){return new Promise(c=>(++this.now,this.now<this.n?c():this.next=c,s.finally(()=>{var u,I,d;if(I=--this.now,{next:d}=this,d&&(delete this.next,d()),I===0&&({done:u}=this,u))return delete this.done,u()})))}all(){return new Promise(s=>this.done=s)}};var C=z(T()),O=z(U());import"util";import nt from"nkn-sdk";import k from"path";import ot from"better-sqlite3";import q from"fs/promises";import{randomBytes as it}from"crypto";var N,_,$;$=k.dirname(k.dirname(new URL(import.meta.url).pathname));N=()=>Buffer.from(it(32)).toString("hex");_=()=>parseInt(new Date/1e3);(async()=>{var a,s,c,u,I,d,l,h,v,P,w,y,f;if(s=new ot(k.join($,"data/ip.db"),{}),s.exec(await q.readFile(k.join($,"ip.sql"),"utf8")),u=s.prepare("INSERT INTO nkn_boot (addr,delay) VALUES(?,?) ON CONFLICT(addr) DO UPDATE SET ok=excluded.ok+1,delay=(excluded.delay+delay)/2,rank=(100000*(ok+100)/(100+ok+err))/delay,utime=?"),c=s.prepare("UPDATE nkn_boot SET ok=ok-1,err=err+1,rank=rank/2 WHERE id=?"),y=async t=>{var e,n,r;return e=new Date-0,{rpcAddr:r}=await nt.rpc.getWsAddr(N(),{rpcServerAddr:`http://${t}`}),n=new Date-e,/^\d+\.\d+\.\d+\.\d+\:\d+$/.test(r)&&console.log(t,u.run((0,C.default)(t),n,parseInt(e/1e3))),r},l=s.prepare("select id,addr from nkn_boot where utime<? or rank=0").all(_()-86400),h=l.length,h===0)for(d="159.203.149.242:30003";;)try{d=await y(d),++h}catch{break}v=new B(128),w=async({id:t,addr:e})=>{var n,r;for(r=[];;){d=(0,O.default)(e);try{d=await y(d)}catch(o){n=o,console.log("\u274C",t,d,n),c.run(t);break}if(console.log(h),h>2048||++h%5==0)break;r.push(void 0)}return r};for(I of l)await v.add(w(I));await v.all(),s.exec("DELETE FROM nkn_boot where ok<=0;VACUUM;"),l=[],P=s.prepare("select addr from nkn_boot order by rank desc,id asc limit 128").iterate();for(f of P)({addr:a}=f),l.push((0,O.default)(a));return await q.writeFile(k.join($,"data/ip"),C.default.multi(l)),process.exit()})();
//!/usr/bin/env coffee
